<!-- Language Handler Script -->
<script>
(function() {
  // Language configuration
  const LANGUAGES = {
    en: { name: 'English', flag: 'ðŸ‡¬ðŸ‡§', default: true },
    de: { name: 'Deutsch', flag: 'ðŸ‡©ðŸ‡ª' }
  };
  
  const COOKIE_NAME = 'spellcode_language';
  const COOKIE_EXPIRY_DAYS = 365;
  
  // Cookie utilities
  function setCookie(name, value, days) {
    const expires = new Date();
    expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
    document.cookie = name + '=' + value + ';expires=' + expires.toUTCString() + ';path=/';
  }
  
  function getCookie(name) {
    const nameEQ = name + '=';
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
      let c = ca[i];
      while (c.charAt(0) === ' ') c = c.substring(1, c.length);
      if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
  }
  
  // Detect current page language
  function getCurrentLanguage() {
    const pathname = window.location.pathname;
    const baseUrl = '{{ site.baseurl }}';
    
    // Check if page has German language indicators
    if (pathname.includes('.de.') || pathname.includes('-de/') || pathname.includes('index.de.html')) {
      return 'de';
    }
    return 'en';
  }
  
  // Get equivalent page in target language
  function getPageInLanguage(targetLang, currentPath) {
    const baseUrl = '{{ site.baseurl }}';
    const currentLang = getCurrentLanguage();
    
    if (currentLang === targetLang) {
      return currentPath;
    }
    
    // Convert between language versions
    if (targetLang === 'de') {
      // Convert English to German
      if (currentPath.includes('/lessons/lesson')) {
        return currentPath.replace(/\/lessons\/(lesson\d+)\//, '/lessons/$1-de/');
      } else if (currentPath.includes('/lessons/outline/')) {
        return currentPath.replace('/lessons/outline/', '/lessons/outline-de/');
      } else if (currentPath === baseUrl + '/' || currentPath === '/') {
        return baseUrl + '/index.de.html';
      }
    } else {
      // Convert German to English
      if (currentPath.includes('/lessons/lesson') && currentPath.includes('-de/')) {
        return currentPath.replace(/\/lessons\/(lesson\d+)-de\//, '/lessons/$1/');
      } else if (currentPath.includes('/lessons/outline-de/')) {
        return currentPath.replace('/lessons/outline-de/', '/lessons/outline/');
      } else if (currentPath.includes('index.de.html')) {
        return baseUrl + '/';
      }
    }
    
    // Fallback to homepage
    return targetLang === 'en' ? baseUrl + '/' : baseUrl + '/index.de.html';
  }
  
  // Rewrite all internal links based on current language
  function rewriteLinksForLanguage(language) {
    const links = document.querySelectorAll('a[href]');
    const baseUrl = '{{ site.baseurl }}';
    
    links.forEach(link => {
      const href = link.getAttribute('href');
      
      // Skip external links and anchors
      if (href.startsWith('http') || href.startsWith('#') || href.startsWith('mailto:')) {
        return;
      }
      
      // Handle relative URLs
      let targetUrl = href;
      
      if (language === 'de') {
        // Convert to German versions
        if (href.includes('/lessons/outline/')) {
          targetUrl = href.replace('/lessons/outline/', '/lessons/outline-de/');
        } else if (href.includes('/lessons/lesson')) {
          targetUrl = href.replace(/\/lessons\/(lesson\d+)\//, '/lessons/$1-de/');
        } else if (href === '/' || href === baseUrl + '/') {
          targetUrl = baseUrl + '/index.de.html';
        }
      } else {
        // Convert to English versions
        if (href.includes('/lessons/outline-de/')) {
          targetUrl = href.replace('/lessons/outline-de/', '/lessons/outline/');
        } else if (href.includes('/lessons/lesson') && href.includes('-de/')) {
          targetUrl = href.replace(/\/lessons\/(lesson\d+)-de\//, '/lessons/$1/');
        } else if (href.includes('index.de.html')) {
          targetUrl = baseUrl + '/';
        }
      }
      
      link.setAttribute('href', targetUrl);
    });
  }
  
  // Change language function
  window.changeLanguage = function(langCode) {
    // Save preference in cookie
    setCookie(COOKIE_NAME, langCode, COOKIE_EXPIRY_DAYS);
    
    // Navigate to equivalent page in target language
    const currentPath = window.location.pathname;
    const targetPath = getPageInLanguage(langCode, currentPath);
    window.location.href = targetPath;
  };
  
  // Initialize on page load
  document.addEventListener('DOMContentLoaded', function() {
    const savedLanguage = getCookie(COOKIE_NAME);
    const currentLanguage = getCurrentLanguage();
    const preferredLanguage = savedLanguage || navigator.language.substr(0, 2) || 'en';
    
    // Update language dropdown
    const dropdown = document.getElementById('language-dropdown');
    if (dropdown) {
      dropdown.value = currentLanguage;
    }
    
    // Rewrite links for current language
    rewriteLinksForLanguage(currentLanguage);
    
    // Language preference is saved in cookie and can be changed via dropdown
  });
  

})();
</script> 